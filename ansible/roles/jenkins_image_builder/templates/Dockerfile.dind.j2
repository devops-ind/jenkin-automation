# Jenkins DIND (Docker-in-Docker) Agent Dockerfile
# Generated by Ansible for {{ deployment_mode }} deployment

FROM alpine:latest

# Install dependencies
RUN apk add --no-cache \
    openssh \
    docker \
    docker-compose \
    git \
    python3 \
    py3-pip

# Install Jenkins agent
RUN wget https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting/4.7/remoting-4.7.jar -O /usr/share/jenkins/agent.jar

# Create jenkins user
RUN addgroup -S jenkins && adduser -S jenkins -G jenkins

# Add jenkins user to docker group
RUN addgroup jenkins docker

# Configure SSH server
RUN ssh-keygen -A
RUN echo "PasswordAuthentication no" >> /etc/ssh/sshd_config
RUN echo "ChallengeResponseAuthentication no" >> /etc/ssh/sshd_config

# Expose SSH port
EXPOSE 22

# Start SSH server
CMD ["/usr/sbin/sshd", "-D"]

# Create Docker daemon configuration for DIND
RUN mkdir -p /etc/docker
RUN echo '{\n  "storage-driver": "overlay2",\n  "hosts": ["unix:///var/run/docker.sock", "tcp://0.0.0.0:2376"],\n  "tls": false\n}' > /etc/docker/daemon.json

# Create directories and set permissions
RUN mkdir -p /home/jenkins/agent /var/lib/docker \
    && chown -R jenkins:jenkins /home/jenkins \
    && chmod 755 /var/lib/docker

{% if jenkins_ssl_enabled %}
# Copy corporate certificates if they exist
COPY certificates/*.crt /usr/local/share/ca-certificates/ 2>/dev/null || true
RUN update-ca-certificates
{% endif %}

# Switch back to jenkins user
USER jenkins

# Set up shell environment with Docker shortcuts
RUN echo 'alias ll="ls -la"' >> ~/.bashrc \
    && echo 'alias d="docker"' >> ~/.bashrc \
    && echo 'alias dc="docker compose"' >> ~/.bashrc \
    && echo 'alias dps="docker ps --format \"table {{.Names}}\t{{.Status}}\t{{.Ports}}\""' >> ~/.bashrc \
    && echo 'alias dpsa="docker ps -a --format \"table {{.Names}}\t{{.Status}}\t{{.Ports}}\""' >> ~/.bashrc \
    && echo 'alias dimages="docker images --format \"table {{.Repository}}\t{{.Tag}}\t{{.Size}}\""' >> ~/.bashrc

# Set working directory
WORKDIR /home/jenkins/agent

# Environment variables for DIND operations
ENV DOCKER_HOST={{ docker_host }}
ENV JENKINS_AGENT_WORKDIR=/home/jenkins/agent
ENV DOCKER_BUILDKIT=1
ENV COMPOSE_DOCKER_CLI_BUILD=1
ENV DEPLOYMENT_MODE={{ deployment_mode }}

# Add deployment labels
LABEL jenkins.deployment_mode="{{ deployment_mode }}"
LABEL jenkins.agent_type="dind"
LABEL jenkins.generated_by="ansible"
LABEL jenkins.generated_at="{{ ansible_date_time.iso8601 }}"

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD pgrep -f "jenkins-agent" && docker version || exit 1

# Default entrypoint from parent image
ENTRYPOINT ["/usr/local/bin/jenkins-agent"]