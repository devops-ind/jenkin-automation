# HAProxy Load Balancer for Jenkins Infrastructure
# Generated by Ansible for {{ deployment_mode }} deployment

FROM haproxy:{{ haproxy_version | default('2.8') }}-alpine

# Install additional packages for corporate environment
RUN apk add --no-cache \
    openssl \
    ca-certificates \
    curl \
    && rm -rf /var/cache/apk/*

# Create haproxy user and group (Alpine doesn't include them by default)
RUN addgroup -g 99 haproxy && \
    adduser -D -u 99 -G haproxy haproxy

# Create necessary directories for configuration and certificates
RUN mkdir -p /etc/haproxy/errors \
    /etc/ssl/certs \
    /etc/ssl/private \
    /var/lib/haproxy \
    && chown -R haproxy:haproxy /var/lib/haproxy

# Copy corporate certificates if SSL is enabled
{% if jenkins_ssl_enabled | default(false) %}
COPY certificates/{{ jenkins_domain }}.pem /etc/ssl/certs/{{ jenkins_domain }}.pem
{% if haproxy_ssl_dhparam_path is defined %}
COPY certificates/dhparam.pem /etc/ssl/certs/dhparam.pem
{% endif %}
{% endif %}

# Copy HAProxy configuration
COPY haproxy.cfg /usr/local/etc/haproxy/haproxy.cfg

# Create custom error pages for better user experience
RUN echo 'HTTP/1.0 503 Service Unavailable\r\nCache-Control: no-cache\r\nConnection: close\r\nContent-Type: text/html\r\n\r\n<html><body><h1>Jenkins Temporarily Unavailable</h1><p>The Jenkins service is currently unavailable. Please try again in a few moments.</p></body></html>' > /etc/haproxy/errors/503.http

# Set proper permissions for SSL certificates
{% if jenkins_ssl_enabled | default(false) %}
RUN chown root:haproxy /etc/ssl/certs/{{ jenkins_domain }}.pem \
    && chmod 640 /etc/ssl/certs/{{ jenkins_domain }}.pem
{% endif %}

# Health check to ensure HAProxy is running and can reach Jenkins
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:{{ haproxy_health_port | default('8405') }}/health || exit 1

# Add deployment labels for management
LABEL jenkins.component="load-balancer" \
      jenkins.deployment_mode="{{ deployment_mode }}" \
      jenkins.domain="{{ jenkins_domain }}" \
      jenkins.generated_by="ansible" \
      jenkins.generated_at="{{ ansible_date_time.iso8601 }}"

# Expose HTTP, HTTPS, stats, and health check ports
EXPOSE 80 443 {{ haproxy_stats_port | default('8404') }} {{ haproxy_health_port | default('8405') }}

# Use the default HAProxy entrypoint with our configuration
CMD ["haproxy", "-f", "/usr/local/etc/haproxy/haproxy.cfg", "-db"]