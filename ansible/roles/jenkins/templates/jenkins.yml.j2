# Jenkins Configuration as Code (JCasC)
# Generated by Ansible for {{ deployment_mode }} deployment

jenkins:
  systemMessage: "Jenkins Master - {{ deployment_mode | title }} Deployment\nConfigured via Ansible + JCasC"
  
  # No executors on master - use agents only
  numExecutors: 0
  
  # Security configuration
  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "{{ jenkins_admin_user }}"
          password: "{{ jenkins_admin_password }}"

  authorizationStrategy:
    roleBased:
      roles:
        global:
          - name: "admin"
            description: "Jenkins administrators"
            permissions:
              - "Overall/Administer"
            assignments:
              - "{{ jenkins_admin_user }}"
          - name: "developer"
            description: "Developers with build permissions"
            permissions:
              - "Overall/Read"
              - "Job/Build"
              - "Job/Cancel"
              - "Job/Read"
              - "Job/Workspace"
              - "View/Read"
            assignments:
              - "authenticated"

  # Static nodes configuration
  nodes:
    - permanent:
        name: "{{ jenkins_dind_agent.name }}"
        description: "Static Docker-in-Docker agent for managing dynamic nodes ({{ deployment_mode }})"
        numExecutors: {{ jenkins_dind_agent.executors }}
        mode: NORMAL
        labelString: "{{ jenkins_dind_agent.labels }}"
        remoteFS: "{{ jenkins_dind_agent.workspace }}"
        launcher:
          inbound:
            workDirSettings:
              disabled: false
              failIfWorkDirIsMissing: false
              internalDir: "remoting"
        retentionStrategy: "always"
        nodeProperties:
          - envVars:
              env:
                - key: "DOCKER_HOST"
                  value: "{{ docker_host }}"
                - key: "DOCKER_BUILDKIT"
                  value: "1"
                - key: "DEPLOYMENT_MODE"
                  value: "{{ deployment_mode }}"

  # Global environment variables
  globalNodeProperties:
    - envVars:
        env:
          - key: "DOCKER_HOST"
            value: "{{ docker_host }}"
          - key: "DEPLOYMENT_MODE"
            value: "{{ deployment_mode }}"

  # Docker Cloud for dynamic agents
  clouds:
    - docker:
        name: "docker-cloud-{{ deployment_mode }}"
        dockerApi:
          dockerHost:
            uri: "{{ docker_host }}"
        templates:
          # Python dynamic agent
          - labelString: "python-dynamic"
            dockerTemplateBase:
              image: "python:3.9-slim"
              mounts:
                - "type=volume,source=pip-cache,destination=/home/jenkins/.cache/pip"
                - "type=volume,source=jenkins-workspace,destination=/home/jenkins/agent"
              environmentsString: |
                PIP_CACHE_DIR=/home/jenkins/.cache/pip
                JENKINS_AGENT_WORKDIR=/home/jenkins/agent
                DEPLOYMENT_MODE={{ deployment_mode }}
            remoteFs: "/home/jenkins/agent"
            connector:
              attach:
                user: "jenkins"
            instanceCapStr: "5"
            retentionStrategy:
              idleMinutes: 10
            removeVolumes: true
            pullStrategy: PULL_LATEST

# Global tool configurations
tool:
  maven:
    installations:
      - name: "Maven-3.9"
        home: "/opt/maven"
        properties:
          - installSource:
              installers:
                - maven:
                    id: "3.9.4"

  git:
    installations:
      - name: "Default Git"
        home: "git"

  jdk:
    installations:
      - name: "OpenJDK-11"
        home: "/opt/java/openjdk"
        properties:
          - installSource:
              installers:
                - adoptOpenJdkInstaller:
                    id: "jdk-11.0.16+8"

# Additional configurations
unclassified:
  # Email configuration
  mailer:
    defaultSuffix: "@{{ ansible_domain | default('company.com') }}"
    smtpHost: "{{ smtp_host | default('localhost') }}"
    smtpPort: "{{ smtp_port | default('25') }}"

  # Pipeline configuration for performance
  globalDefaultFlowDurabilityLevel:
    durabilityHint: PERFORMANCE_OPTIMIZED

  # Git global configuration
  gitSCM:
    globalConfigName: "Jenkins ({{ deployment_mode }})"
    globalConfigEmail: "jenkins@{{ ansible_domain | default('company.com') }}"